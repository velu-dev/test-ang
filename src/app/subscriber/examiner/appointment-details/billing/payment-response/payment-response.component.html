<mat-card class="m-card m-t-20">
    <mat-card-header>
        <div class="content-wrapper-main-title">Payment Responses</div>
        <span class="spacer"></span>
    </mat-card-header>
    <mat-divider></mat-divider>
    <mat-card-content class="m-b-10">
        <form [formGroup]="paymentForm" fxLayout="row wrap">
            <div class="user-detail m-t-10" formArrayName="payments">
                <table class="table res-table pay-response">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Bill #</th>
                            <th>Submission</th>
                            <th>Date Sent</th>
                            <th>Due Date</th>
                            <th>Charge</th>
                            <th>Payment</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <thead *ngFor="let payment of payments().controls; let payIndex=index" [formGroupName]="payIndex">
                        <tr>
                            <td>
                                <mat-icon class="text-success" (click)="openElement(payment.get('id').value)">{{expandId
                                    == payment.get('id').value ? 'remove_circle' : 'add_circle'}}</mat-icon>
                            </td>
                            <td>{{payment.get('bill_no').value}}</td>
                            <td>{{payment.get('bill_submission_type').value}}</td>
                            <td>{{payment.get('date_sent').value | date:'MM-dd-yyyy'}}</td>
                            <td>{{payment.get('bill_due_date').value | date:'MM-dd-yyyy'}}</td>
                            <td>{{payment.get('charge').value}}</td>
                            <td>{{payment.get('payment').value}}</td>
                            <td class="text-danger">{{payment.get('balance').value}}</td>
                            <td class="text-success">{{payment.get('status').value}}</td>
                            <td><button type="button" *ngIf="paymentReviews(payIndex)?.controls?.length == 0" mat-raised-button class="mini-btn filled-gray"
                                    (click)="openElement(payment.get('id').value);paymentReviews(payIndex)?.controls?.length == 0 ? addReviews(payIndex) : ''">Add
                                    Response</button></td>
                        </tr>

                        <tr formArrayName="reviews" *ngIf="expandId == payment.get('id').value">
                            <td colspan="10">
                                <div class="detail"
                                    *ngFor="let review of paymentReviews(payIndex).controls; let reviewIndex=index;let last = last">
                                    <div [formGroupName]="reviewIndex">
                                        <!-- HIde section  && !(paymentReviews(payIndex).at(paymentReviews(payIndex)?.controls?.length -1).get('showStatus').value && reviewIndex == paymentReviews(payIndex)?.controls?.length -2) -->
                                        <div class="expand-details-list" fxLayout="row wrap" *ngIf="!review.get('showStatus').value">
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100" class="expand-details" [ngClass]="{'strike' : !last}">
                                                <div><span class="prp_">Explanation of Review</span><span
                                                        class="prv_"><a class="text-ternary" (click)="download(review.get('file_url').value)">{{review.get('file_name').value}}</a>
                                                    </span>
                                                </div>
                                                <div><span class="prp_">Post Date</span><span
                                                        class="prv_">{{review.get('post_date').value | date:'MM-dd-yyyy'}}</span></div>
                                                <div><span class="prp_">Effective Date</span><span
                                                        class="prv_">{{review.get('effective_date').value | date:'MM-dd-yyyy'}}</span></div>
                                                <div><span class="prp_">Deposit Date</span><span
                                                        class="prv_">{{review.get('deposit_date').value | date:'MM-dd-yyyy'}}</span></div>
                                                <div><span class="prp_">Created By</span><span class="prv_">{{review.get('created_by_first_name').value}} {{review.get('created_by_last_name').value}}</span></div>
                                                <div><span class="prp_">Created On</span><span class="prv_">{{review.get('createdAt').value | date:'MM-dd-yyyy'}}</span></div>
                                            </div>
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100" class="expand-details" [ngClass]="{'strike' : !last}">
                                                <div><span class="prp_">Payment Amount</span><span
                                                        class="prv_">{{review.get('payment_amount').value}}</span></div>
                                                <div><span class="prp_">Payment Method</span><span
                                                        class="prv_">{{review.get('payment_method').value}}</span></div>
                                                <div><span class="prp_">Penalty Charged</span><span
                                                        class="prv_">{{review.get('penalty_charged').value}}</span></div>
                                                <div><span class="prp_">Penalty Paid</span><span
                                                        class="prv_">{{review.get('penalty_paid').value}}</span></div>
                                                <div><span class="prp_">Updated By</span><span class="prv_">{{review.get('updated_by_first_name').value}} {{review.get('updated_by_last_name').value}}</span></div>
                                                <div><span class="prp_">Updated On</span><span class="prv_">{{review.get('updatedAt').value | date:'MM-dd-yyyy'}}</span></div>
                                            </div>
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100" class="expand-details" [ngClass]="{'strike' : !last}">
                                                <div><span class="prp_">Reference Number</span><span
                                                        class="prv_">{{review.get('reference_no').value}}</span></div>
                                                <div><span class="prp_">Interest Charged</span><span
                                                        class="prv_">{{review.get('interest_charged').value}}</span></div>
                                                <div><span class="prp_">Interest Paid</span><span class="prv_">{{review.get('interest_paid').value}}</span>
                                                </div>
                                                <div><span class="prp_">Void Reason</span><span class="prv_">{{review.get('void_type').value}} - {{review.get('void_reason').value}}</span>
                                                </div>
                                            </div>
                                            <div fxFlex="100">
                                                <button type="button" *ngIf="last && review.get('void_type_id').value != 3" mat-raised-button class="filled-gray m-t-15" (click)="editResponse(payment,review,payIndex,reviewIndex)">Copy & Edit Response</button>

                                            </div>
                                        </div>
                                        <div class="expand-details-list" fxLayout="row wrap" *ngIf="review.get('showStatus').value">
                                            <div fxFlex="100" *ngIf="paymentReviews(payIndex)?.controls?.length > 1">
                                                <div fxLayout="row wrap">
                                                    <div class="main-title p-l-0 p-b-10" fxFlex="100">First Bill Submission Edit
                                                        Reason</div>
                                                    <mat-radio-group aria-label="Select an option" fxFlex="100"
                                                        fxFlex.sm="100" fxFlex.xs="100" (change)="changeVoidType(payment,review,payIndex,reviewIndex,$event)"  formControlName="void_type_id">
                                                        <mat-radio-button *ngFor="let type of review.get('voidData').value" [value]="type?.id" class="m-r-15">{{type?.name}}
                                                        </mat-radio-button>
                                                        <!-- <mat-radio-button value="Correction">Correction 
                                                        </mat-radio-button>
                                                        <mat-radio-button value="Void Payment" class="m-r-15">Void Payment
                                                        </mat-radio-button> -->
                                                    </mat-radio-group>
                                                    <div fxFlex="100" fxFlex.sm="100" fxFlex.xs="100">
                                                        <mat-form-field appearance="outline" class="w-100 m-t-10">
                                                            <mat-label>Reason *</mat-label>
                                                            <input formControlName="void_reason" matInput placeholder="Reason">
                                                            <!-- <mat-error>Error message comes here...</mat-error> -->
                                                        </mat-form-field>
                                                    </div>
                                                    <div *ngIf="review.get('void_type_id').value != 3" class="main-title m-t-10 p-l-0 p-b-10">Add new response</div>
                                                </div>
                                            </div>
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100"
                                                class="expand-details editable" *ngIf="review.get('void_type_id').value != 3">
                                                <div>
                                                    <span class="prp_">Explanation of Review *</span>
                                                    <span class="prv_">
                                                        <div *ngIf="review.get('file_name').value">{{review.get('file_name').value}}</div>
                                                        <button type="button" class="filled-gray mini-btn"
                                                            mat-raised-button [disabled]="review.get('file_name').disabled" (click)="uploader.click()">{{!review.get('file_name').value ? 'Upload' : 'Reupload'}}</button>
                                                            <input type="file" #uploader hidden
                                                            (change)="addEOR($event,review)"
                                                            accept=".pdf, .jpg, .jpeg, .png" required>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Post Date *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="post_date" matInput type="text"
                                                                placeholder="" autocomplete="off" [min]="minimumDate" [matDatepicker]="post_date">
                                                                <mat-datepicker-toggle matSuffix [for]="post_date"></mat-datepicker-toggle>
                                                                <mat-datepicker #post_date></mat-datepicker>    
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Effective Date *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="effective_date" matInput type="text"
                                                                autocomplete="off" placeholder="" [min]="minimumDate" [matDatepicker]="effective">
                                                                <mat-datepicker-toggle matSuffix [for]="effective"></mat-datepicker-toggle>
                                                                <mat-datepicker #effective></mat-datepicker>
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Deposit Date *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="deposit_date" matInput type="text" placeholder=""
                                                                autocomplete="off" [min]="minimumDate" [max]="currentDate" [matDatepicker]="deposited">
                                                                <mat-datepicker-toggle matSuffix [for]="deposited"></mat-datepicker-toggle>
                                                                <mat-datepicker #deposited></mat-datepicker>
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                            </div>
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100"
                                                class="expand-details editable" *ngIf="review.get('void_type_id').value != 3">
                                                <div>
                                                    <span class="prp_">Payment Amount *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="payment_amount" matInput type="number" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Payment Method *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <mat-select formControlName="payment_method">
                                                                <mat-option *ngFor="let payment of paymentTypes" [value]="payment">
                                                                    {{payment}}
                                                                </mat-option>
                                                            </mat-select>
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Penalty Charged</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="penalty_charged" matInput type="number" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Penalty Paid</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="penalty_paid" matInput type="number" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                            </div>
                                            <div fxFlex="33.3" fxFlex.sm="50" fxFlex.xs="100"
                                                class="expand-details editable" *ngIf="review.get('void_type_id').value != 3">
                                                <div>
                                                    <span class="prp_">Reference Number *</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="reference_no" matInput type="text" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Interest Charged</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="interest_charged" matInput type="number" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="prp_">Interest Paid</span>
                                                    <span class="prv_">
                                                        <mat-form-field appearance="outline" class="w-100">
                                                            <input formControlName="interest_paid" matInput type="number" placeholder=""
                                                                autocomplete="off">
                                                        </mat-form-field>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="w-100 text-center p-t-10">
                                                <button type="button" class="outline-danger m-r-10" (click)="removeReview(payIndex,reviewIndex)" mat-stroked-button>Cancel</button>
                                                <button class="outline-success" (click)="saveReview(payment,review,payIndex,reviewIndex)"
                                                    mat-stroked-button>Save</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                    </thead>
                </table>
            </div>
        </form>
        <div fxLayout="row wrap" class="m-t-15">
            <button mat-raised-button class="filled-gray m-r-5" (click)="openCloseBillDialog()">Close Bill</button>
            <!-- <button mat-raised-button class="filled-gray m-r-5" (click)="openLateResponse()">Late Response</button>
            <button mat-raised-button class="filled-gray m-r-5" (click)="openSecondBillReviewDialog()">Second Bill Review</button>
            <button mat-raised-button class="filled-gray" disabled>Independent Bill Review</button> -->

        </div>
    </mat-card-content>
</mat-card>